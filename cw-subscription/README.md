# CosmWasm Subscription Contract

Subscription contract enable merchants to collect payments from user periodically. It works with CW20 tokens, user
should set approval to subscription contract in advance.

## Messages

`CreatePlan(PlanContent{ title, description, token, amount, cron, tzoffset})` - This create a subscription plan by
merchant, `token` is the cw20 token contract address, `cron` and `tzoffset` specifies payment collection intervals in a
way similar to unix crontab([cron specification](#cron-specification). `sender` will become the plan owner and payment
beneficiary.

`StopPlan{ plan_id }` - This stops plan, will automatically unsubscribe all users then delete the plan itself, `sender`
must be the plan owner.

`Subscribe{ plan_id, expires, next_collection_time }` - User subscribe to the plan, `expires` set the expiration time,
support both block height and block time. `next_collection_time` specifies the first payment collection time, it must
match the `cron` in the plan, can be generated by client tools.

`Unsubscribe{ plan_id }` - User unsubscribe from a plan.

`UnsubscribeUser{ plan_id, subscriber }` - Plan owner unsubscribe a user. `sender` must be the plan owner.

`UpdateExpires{ plan_id, expires }` - Subscriber update expiration specification.

`Collection{ items: Vec<CollectOne{ plan_id, subscriber, current_collection_time, next_collection_time}> }` - Off-chain
task trigger collection of a batch of subscriptions, the task calculate `current_collection_time` and
`next_collection_time` according to plan's `cron`.

## Queries

`Plan{ plan_id }` - Query a plan

`ListPlans { start_after, limit }` - Enumerate all plans, support pagination.

`Subscription{ plan_id, subscriber }` - Query a subscription

`ListSubscriptions{ plan_id, start_after, limit }` - Enumerate subscriptions of the plan

`CollectibleSubscriptions{ limit }` - Fetch collectible subscriptions, off-chain task can use this to trigger payment
collections.

## Events

`subscribe{ plan_id, subscriber }` - User subscribe to plan.

`unsubcribe{ plan_id, subscriber }` - User unsubscribe to plan.

`update-subscription{ plan_id, subscriber }` - Subscription is updated, currently only `expires` field is updatable.

`create-plan{ plan_id }` - New plan created.

`stop-plan{ plan_id }` - Plan stopped.

## Cron Specification

We adopt [unix crontab syntax](https://crontab.guru/) to specify payment collection periods of subscription plan, for
example:

- `0 0 1 1 *` yearly
- `0 0 1 * *` monthly
- `0 0 * * 1` weekly
- `0 * * * *` hourly

But before pass it to contract, it must be compiled into bitset format (client tool should be provided to do this
automatically):

- `0 0 1 * *` -> `{"minute":1,"hour":1,"mday":2,"month":8190,"wday":127}`.
